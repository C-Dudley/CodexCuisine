// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mealPlans          MealPlan[]
  favorites          Favorite[]
  dietaryPreferences DietaryPreference[]
  allergies          Allergy[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model Recipe {
  id           String   @id @default(uuid())
  title        String
  instructions String
  cookTime     Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  ingredientLists IngredientList[]
  mealPlans       MealPlan[]
  favorites       Favorite[]

  @@index([title])
  @@index([createdAt])
  @@map("recipes")
}

model Ingredient {
  id        String   @id @default(uuid())
  name      String   @unique
  unit      String?
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ingredientLists IngredientList[]

  @@map("ingredients")
}

model IngredientList {
  id           String  @id @default(uuid())
  quantity     Float?

  // Relations
  recipeId     String
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([recipeId, ingredientId])
  @@index([recipeId])
  @@index([ingredientId])
  @@map("ingredient_lists")
}

model MealPlan {
  id        String   @id @default(uuid())
  date      DateTime
  mealType  String   // Breakfast, Lunch, Dinner

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  recipeId  String?  // Optional for external recipes
  recipe    Recipe?  @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  externalRecipeId String?      // Optional for external recipes
  externalRecipe   ExternalRecipe? @relation(fields: [externalRecipeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([recipeId])
  @@index([date])
  @@index([userId, date])
  @@map("meal_plans")
}

model Favorite {
  id        String   @id @default(uuid())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, recipeId])
  @@index([userId])
  @@index([recipeId])
  @@map("favorites")
}

model DietaryPreference {
  id        String   @id @default(uuid())
  type      String   // vegan, vegetarian, keto, paleo, gluten-free, etc.

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type])
  @@index([userId])
  @@map("dietary_preferences")
}

model Allergy {
  id        String   @id @default(uuid())
  ingredient String  // ingredient name or allergen (nuts, dairy, shellfish, etc.)

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, ingredient])
  @@index([userId])
  @@map("allergies")
}

model ExternalRecipe {
  id          String   @id @default(uuid())
  title       String
  description String?
  instructions String
  cookTime    Int?
  servings    Int?
  imageUrl    String?
  sourceType  String   // "web" or "video"
  sourceUrl   String
  sourceSite  String   // AllRecipes, FoodNetwork, YouTube, TikTok, etc.
  fullText    String   // Full recipe text from source
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  externalIngredients ExternalIngredient[]
  mealPlans           MealPlan[]

  @@index([sourceSite])
  @@index([sourceUrl])
  @@index([createdAt])
  @@map("external_recipes")
}

model ExternalIngredient {
  id          String  @id @default(uuid())
  name        String
  quantity    Float?
  unit        String?

  // Relations
  recipeId    String
  recipe      ExternalRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([recipeId])
  @@map("external_ingredients")
}

model VideoRecipe {
  id            String   @id @default(uuid())
  title         String
  description   String?
  ingredients   String   @default("[]") // JSON array stored as string
  instructions  String   @default("[]") // JSON array of instruction steps
  cookTime      Int?     // In minutes
  servings      Int?
  sourceType    String   // "YouTube" or "TikTok"
  videoId       String
  sourceUrl     String   @unique
  authorName    String
  duration      Int      // Video duration in seconds
  thumbnailUrl  String?
  transcript    String?  // Full video transcript (for YouTube)
  platform      String   // YouTube, TikTok, Instagram (for compatibility)
  extractedRecipeId String? // Link to ExternalRecipe if parsed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([platform])
  @@index([videoId])
  @@index([authorName])
  @@index([createdAt])
  @@map("video_recipes")
}